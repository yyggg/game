import{s as a,i as E,m as L,a as _,d as N,p as w,e as C,g as A,f as S,h as D,u as x}from"./store-CvyK6unv.js";import{u as b,t as k}from"./terminal-CSuUTq_6.js";import{j as i,f as v,r,x as P}from"./index-PFvgZIwd.js";import{H as f}from"./vue-CwFJaX1P.js";var d=(e=>(e[e.UNINSTALLED=0]="UNINSTALLED",e[e.INSTALLED=1]="INSTALLED",e[e.WAIT_INSTALL=2]="WAIT_INSTALL",e[e.CONFLICT_PENDING=3]="CONFLICT_PENDING",e[e.DEPENDENT_WAIT_INSTALL=4]="DEPENDENT_WAIT_INSTALL",e[e.DIRECTORY_OCCUPIED=5]="DIRECTORY_OCCUPIED",e[e.DISABLE=6]="DISABLE",e))(d||{});const M=()=>{a.loading.table=!0,a.table.indexLoaded?y():O().then(()=>{y()})},c=()=>{a.table.indexLoaded=!1;for(const e in a.table.modulesEbak)a.table.modulesEbak[e]=void 0;M()},O=()=>E().then(e=>{a.table.indexLoaded=!0,a.sysVersion=e.data.sysVersion,a.installedModule=e.data.installed;const o=[];if(e.data.installed){for(const t in e.data.installed)o.push(e.data.installed[t].uid);a.installedModuleUids=o}}),y=()=>{if(typeof a.table.modulesEbak[a.table.params.activeTab]<"u"){a.table.modules[a.table.params.activeTab]=T(a.table.modulesEbak[a.table.params.activeTab]),a.loading.table=!1;return}const e={};for(const n in a.table.params)a.table.params[n]!=""&&(e[n]=a.table.params[n]);const o=[],t=[];a.installedModule.forEach(n=>{t.push({uid:n.uid,version:n.version})}),e.installed=t,e.sysVersion=a.sysVersion,L(e).then(n=>{e.activeTab=="all"&&(n.data.rows.forEach(l=>{o.push(l.uid)}),a.installedModule.forEach(l=>{o.indexOf(l.uid)===-1&&(a.table.params.quickSearch?l.title.includes(a.table.params.quickSearch)&&n.data.rows.push(l):n.data.rows.push(l))})),a.table.remark=n.data.remark,a.table.modulesEbak[e.activeTab]=n.data.rows.map(l=>{const s=a.installedModuleUids.indexOf(l.uid);return s!==-1?(l.state=a.installedModule[s].state,l.version=a.installedModule[s].version,l.website=a.installedModule[s].website,l.stateTag=R(l.state)):l.state=0,l.new_version&&l.tags&&l.tags.push({name:i.global.t("module.New version"),type:"danger"}),l}),a.table.modules[e.activeTab]=T(a.table.modulesEbak[e.activeTab]),a.table.category=n.data.category}).finally(()=>{a.loading.table=!1})},I=e=>{a.dialog.goodsInfo=!0,a.loading.goodsInfo=!0;const o=a.installedModule.find(t=>t.uid==e);_({uid:e,localVersion:o==null?void 0:o.version,sysVersion:a.sysVersion}).then(t=>{o?(t.data.info.type=="local"?(t.data.info=o,t.data.info.images=[v("/static/images/local-module-logo.png")],t.data.info.type="local"):(t.data.info.type="online",t.data.info.state=o.state,t.data.info.version=o.version),t.data.info.enable=o.state!==d.DISABLE):(t.data.info.state=0,t.data.info.type="online"),a.goodsInfo=t.data.info}).catch(t=>{u(t)&&(a.dialog.goodsInfo=!1)}).finally(()=>{a.loading.goodsInfo=!1})},z=(e=!1)=>{a.dialog.buy=!0,a.loading.buy=!0,N({goods_id:a.goodsInfo.id}).then(o=>{a.loading.buy=!1,a.buy.renew=e,a.buy.info=o.data.info}).catch(o=>{a.dialog.buy=!1,a.loading.buy=!1,u(o)})},q=e=>{a.common.payType=e,a.loading.common=!0,w(a.buy.info.id,e).then(o=>{if(a.dialog.buy=!1,a.dialog.goodsInfo=!1,e=="wx"||e=="zfb"){a.dialog.pay=!0,a.payInfo=o.data;const t=setInterval(()=>{C(a.payInfo.info.sn).then(()=>{a.payInfo.pay.status="success",clearInterval(t),a.buy.renew?I(o.data.info.uid):p(o.data.info.uid,o.data.info.id),a.dialog.pay=!1}).catch(()=>{})},3e3)}else a.buy.renew?I(o.data.info.uid):p(o.data.info.uid,o.data.info.id)}).catch(o=>{u(o)}).finally(()=>{a.loading.common=!1})},g=e=>{a.common.type="loading",a.common.loadingTitle=e,a.common.loadingComponentKey=P()},p=(e,o)=>{a.dialog.common=!0,g("init"),a.common.dialogTitle=i.global.t("module.Install"),A(e).then(t=>{t.data.state===d.INSTALLED||t.data.state===d.DISABLE||t.data.state===d.DIRECTORY_OCCUPIED?(f({type:"error",message:t.data.state===d.INSTALLED||t.data.state===d.DISABLE?i.global.t("module.Installation cancelled because module already exists!"):i.global.t("module.Installation cancelled because the directory required by the module is occupied!")}),a.dialog.common=!1):(g(t.data.state===d.UNINSTALLED?"download":"install"),h(e,o),a.dialog.baAccount=!1,a.dialog.buy=!1,a.dialog.goodsInfo=!1)})},h=(e,o,t={})=>{S(e,o,t).then(()=>{a.common.dialogTitle=i.global.t("module.Installation complete"),a.common.moduleState=d.INSTALLED,a.common.type="done",c()}).catch(n=>{if(!u(n))if(n.code==-1)a.common.uid=n.data.uid,a.common.type="InstallConflict",a.common.dialogTitle=i.global.t("module.A conflict is found Please handle it manually"),a.common.fileConflict=n.data.fileConflict,a.common.dependConflict=n.data.dependConflict;else if(n.code==-2){a.common.type="done",a.common.uid=n.data.uid,a.common.dialogTitle=i.global.t("module.Wait for dependent installation"),a.common.moduleState=d.DEPENDENT_WAIT_INSTALL,a.common.waitInstallDepend=n.data.wait_install,a.common.dependInstallState="executing";const l=b();n.data.wait_install.includes("npm_dependent_wait_install")&&l.addTaskPM("web-install",!0,"module-install:"+n.data.uid,s=>{m(s,"npm_dependent_wait_install")}),n.data.wait_install.includes("nuxt_npm_dependent_wait_install")&&l.addTaskPM("nuxt-install",!0,"module-install:"+n.data.uid,s=>{m(s,"nuxt_npm_dependent_wait_install")}),n.data.wait_install.includes("composer_dependent_wait_install")&&l.addTask("composer.update",!0,"module-install:"+n.data.uid,s=>{m(s,"composer_dependent_wait_install")})}else n.code==0&&(f({type:"error",message:n.msg,zIndex:9999}),a.dialog.common=!1,c())}).finally(()=>{a.loading.common=!1})},m=(e,o)=>{e==k.Success?(a.common.waitInstallDepend=a.common.waitInstallDepend.filter(t=>t!=o),a.common.waitInstallDepend.length==0&&(a.common.dependInstallState="success",r.currentRoute.value.name==="moduleStore/moduleStore"&&c())):(b().toggle(!0),a.common.dependInstallState="fail",r.currentRoute.value.name==="moduleStore/moduleStore"&&c()),r.currentRoute.value.name},G=(e=!1)=>{if(a.loading.common=!0,e){const o={};for(const t in a.common.disableDependConflict)a.common.disableDependConflict[t].solution=="delete"&&(typeof o[a.common.disableDependConflict[t].env]>"u"&&(o[a.common.disableDependConflict[t].env]=[]),o[a.common.disableDependConflict[t].env].push(a.common.disableDependConflict[t].depend));a.common.disableParams.confirmConflict=1,a.common.disableParams.dependConflictSolution=o}D(a.common.disableParams).then(()=>{f({type:"success",message:i.global.t("module.The operation succeeds Please clear the system cache and refresh the browser ~"),zIndex:9999}),a.dialog.common=!1,c()}).catch(o=>{if(o.code==-1){if(a.dialog.common=!0,a.common.dialogTitle=i.global.t("module.Deal with conflict"),a.common.type="disableConfirmConflict",a.common.disableDependConflict=o.data.dependConflict,o.data.conflictFile&&o.data.conflictFile.length){const t=[];for(const n in o.data.conflictFile)t.push({file:o.data.conflictFile[n]});a.common.disableConflictFile=t}}else if(o.code==-2){a.dialog.common=!0;const t={type:"disable",commands:o.data.wait_install};a.common.uid=a.goodsInfo.uid,U(t)}else o.code==-3?p(a.goodsInfo.uid,a.goodsInfo.purchased):(f({type:"error",message:o.msg,zIndex:9999}),c())}).finally(()=>{a.loading.common=!1})},Y=e=>{a.loading.common=!0,D({uid:e,state:1}).then(()=>{a.dialog.common=!0,g("init"),a.common.dialogTitle=i.global.t("Enable"),h(e,0),a.dialog.goodsInfo=!1}).catch(o=>{f({type:"error",message:o.msg,zIndex:9999})})},u=e=>{const o=x();return e.code==301||e.code==408?(o.removeToken(),a.dialog.baAccount=!0,!0):!1},T=e=>a.table.onlyLocal?e.filter(o=>o.state>d.UNINSTALLED):e,U=e=>{if(e.type=="disable"){a.dialog.common=!0,a.common.type="done",a.common.dialogTitle=i.global.t("module.Wait for dependent installation"),a.common.moduleState=d.DISABLE,a.common.dependInstallState="executing";const o=b();e.commands.forEach(t=>{a.common.waitInstallDepend.push(t.type),t.pm?(t.command=="web-install",o.addTaskPM(t.command,!0,"",n=>{m(n,t.type),t.command=="web-install"})):o.addTask(t.command,!0,"",n=>{m(n,t.type)})})}},H=e=>e.nickname+"（"+(e.email||e.mobile||"ID:"+e.id)+"）",j=(e,o)=>typeof e>"u"||typeof o>"u"?"-":o==0?parseInt(e.toString())+i.global.t("module.Points"):"￥"+e,R=e=>{switch(e){case d.INSTALLED:return{type:"",text:i.global.t("module.installed")};case d.WAIT_INSTALL:return{type:"success",text:i.global.t("module.Wait for installation")};case d.CONFLICT_PENDING:return{type:"danger",text:i.global.t("module.Conflict pending")};case d.DEPENDENT_WAIT_INSTALL:return{type:"warning",text:i.global.t("module.Dependency to be installed")};case d.DISABLE:return{type:"warning",text:i.global.t("Disable")};default:return{type:"info",text:i.global.t("Unknown")}}};export{p as a,c as b,j as c,G as d,h as e,z as f,I as g,Y as h,M as i,u as l,d as m,q as o,H as s};
